<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Celebration Agent â€“ CometChat Widget</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- CometChat Visual Builder (No-Code) -->
  <script defer src="https://cdn.jsdelivr.net/npm/@cometchat/chat-embed@latest/dist/main.js"></script>
  <!-- <script defer src="https://cdn.jsdelivr.net/npm/cometchat-visual-builder-no-code@1.0.10-test33/dist/main.js"></script> -->
  <style>
    html,body { height:100%; margin:0; background-color:#d6d6d6; font-family: system-ui, Arial, sans-serif; }
    #cometChatMount { height:100%; }
  </style>
  <script>
    // Base URL for our Product Hunt Agent API
    window.PH_AGENT_API = window.PH_AGENT_API || (location.origin.includes('github.io') ? 'https://your-server.example.com' : 'http://localhost:8787');
  </script>
  <script>
  // --- CometChat Credentials ---
  const COMETCHAT_CREDENTIALS = {
    appID: "280833fdbfc2ef3b",
    appRegion: "us",
    authKey: "9762f51fb296e579cb4a268099e40c2bcde5c4ae",
  };

  // --- Tool Handlers ---
  // Normalizes tool args (string or object)
  function normalizeArgs(args){
    if (typeof args === 'string') {
      try { return JSON.parse(args); } catch { return { value: args }; }
    }
    return (typeof args === 'object' && args) ? args : {};
  }

  // Confetti tool
  function handleConfetti(args){
    let cfg = normalizeArgs(args);
    const defaults = {
      particleCount: 180,
      spread: 90,
      startVelocity: 45,
      ticks: 200,
      origin: { x: 0.5, y: 0.5 },
      colors: ['#ff577f','#ff884b','#ffd384','#fff9b0','#00c2ff','#7b5cff']
    };
    const finalCfg = {
      ...defaults,
      ...cfg,
      origin: {
        x: (cfg.origin && typeof cfg.origin.x === 'number') ? cfg.origin.x : defaults.origin.x,
        y: (cfg.origin && typeof cfg.origin.y === 'number') ? cfg.origin.y : defaults.origin.y,
      }
    };
    loadConfetti().then(c => {
      if (!c) return fallbackConfetti();
      c({
        particleCount: finalCfg.particleCount,
        spread: finalCfg.spread,
        startVelocity: finalCfg.startVelocity,
        origin: finalCfg.origin,
        colors: finalCfg.colors,
        ticks: finalCfg.ticks,
      });
      console.log('[Confetti] Fired', finalCfg);
    });
    // Return a small acknowledgement so the assistant can use it
    return { ok: true };
  }

  function loadConfetti(){
    return new Promise(resolve => {
      if (window.confetti) return resolve(window.confetti);
      const existing = document.querySelector('script[data-confetti]');
      if (existing) {
        existing.addEventListener('load', () => resolve(window.confetti));
        return;
      }
      const s = document.createElement('script');
      s.dataset.confetti = 'true';
      s.src = 'https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.0/dist/confetti.browser.min.js';
      s.onload = () => resolve(window.confetti);
      s.onerror = () => { console.warn('[Confetti] Failed to load library, using fallback'); resolve(null); };
      document.head.appendChild(s);
    });
  }

  function fallbackConfetti(){
    const existing = document.getElementById('fallback-confetti-canvas');
    const canvas = existing || Object.assign(document.body.appendChild(document.createElement('canvas')), { id: 'fallback-confetti-canvas' });
    canvas.style.cssText = 'position:fixed;inset:0;pointer-events:none;z-index:9999';
    canvas.width = innerWidth; canvas.height = innerHeight;
    const ctx = canvas.getContext('2d');
    const pieces = Array.from({length:100}, () => ({ x: Math.random()*canvas.width, y: -20-Math.random()*canvas.height, r: 4+Math.random()*5, c: `hsl(${Math.random()*360},90%,60%)`, vy: 2+Math.random()*3, vx: -1+Math.random()*2 }));
    let frames = 0; (function loop(){ frames++; if(frames>240) return; requestAnimationFrame(loop); ctx.clearRect(0,0,canvas.width,canvas.height); pieces.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; if(p.y>canvas.height) p.y=-10; ctx.fillStyle=p.c; ctx.fillRect(p.x,p.y,p.r,p.r); }); })();
  }

  // Tool: get-top-products => calls our backend /api/top
  async function toolGetTopProducts(args){
    const { date } = normalizeArgs(args);
    const api = window.PH_AGENT_API || 'http://localhost:8787';
    // Default to current date in India timezone when not provided
    const d = date || new Intl.DateTimeFormat('en-CA', { timeZone: 'Asia/Kolkata', year: 'numeric', month: '2-digit', day: '2-digit' }).format(new Date());
    try {
      const r = await fetch(`${api}/api/top?date=${encodeURIComponent(d)}`);
      const j = await r.json();
      // Shape expected by the agent tool schema
      return { posts: (j.posts || []).map(p => ({
        id: p.id, name: p.name, tagline: p.tagline, url: p.url, website: p.website, votesCount: p.votesCount, thumbnail: p.thumbnail
      })) };
    } catch (e) {
      console.warn('[get-top-products] failed', e);
      return { posts: [] };
    }
  }

  // Tool: search-products => calls our backend /api/search
  async function toolSearchProducts(args){
    const { query } = normalizeArgs(args);
    const api = window.PH_AGENT_API || 'http://localhost:8787';
    const q = (query || '').toString();
    if (!q) return { hits: [] };
    try {
      const r = await fetch(`${api}/api/search?q=${encodeURIComponent(q)}`);
      const j = await r.json();
      return { hits: (j.hits || []).map(h => ({
        id: h.objectID, objectID: h.objectID, name: h.name, tagline: h.tagline, url: h.url, website: h.website, votesCount: h.votesCount, thumbnail: h.thumbnail
      })) };
    } catch (e) {
      console.warn('[search-products] failed', e);
      return { hits: [] };
    }
  }

  // --- CometChat Launch Options ---

  const COMETCHAT_LAUNCH_OPTIONS = {
    targetElementID: 'cometChatMount',  // Element ID to mount the widget
    isDocked: true, // true = floating bubble, false = embedded
    width: '700px', // Widget width
    height: '500px',  // Widget height
    chatType: "user",
    defaultChatID: "36735525-0266-4405-96c1-509afa10c334",  // Agent ID to open chat by default
    variantID: "68b5727f5b631d82aa900be4",  // Variant configuration ID

    // Optional advanced settings:
    // dockedAlignment: "right",  // For docked mode: "left" or "right"
    aiAssistantTools:{
      // Confetti tools
      'show-confetti': handleConfetti,
      'confetti-tool': handleConfetti,
      // Product Hunt agent tools
      'get-top-products': toolGetTopProducts,
      'search-products': toolSearchProducts,
    }
  }

  const COMETCHAT_USER_UID = 'cometchat-uid-2'; // Replace with your actual user UID

  window.addEventListener('DOMContentLoaded', () => {
    CometChatApp.init(COMETCHAT_CREDENTIALS)
      .then(() => CometChatApp.login({ uid: COMETCHAT_USER_UID }))
      .then(() => CometChatApp.launch(COMETCHAT_LAUNCH_OPTIONS))
      .then(() => { console.log('[CometChat] Chat launched!'); })
      .catch((error) => { console.error('[CometChat] Error:', error); });
  });
  </script>
</head>
<body>
  <div id="cometChatMount"></div>
</body>
</html>
